parameters:
  - name: DOCKERPATH
    type: string
  - name: IMAGENAME
    type: string
  - name: containerName
    type: string
  - name: targetFolder
    type: string

steps:
  - task: Bash@3
    displayName: 'Build & Push ${{ parameters.IMAGENAME }}'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        if [ "${{ parameters.IMAGENAME }}" = "webapigateway" ]; then
          chmod +x ./subgraph.sh
          ./subgraph.sh ApiGateways/Web.ApiGateway/appsettings.Production.json Services
        fi
        docker build --no-cache -t $(ACRPRODLOGINSERVER)/${{ parameters.IMAGENAME }}:$(TAG) . -f ${{ parameters.DOCKERPATH }}/Dockerfile
        docker push $(ACRPRODLOGINSERVER)/${{ parameters.IMAGENAME }}:$(TAG)
        docker rmi $(ACRPRODLOGINSERVER)/${{ parameters.IMAGENAME }}:$(TAG)
        docker system prune -a --volumes -f
        sleep 5

  - task: AzureContainerApps@1
    displayName: 'Deploy to ${{ parameters.containerName }}'
    inputs:
      azureSubscription: $(SUBSCRIPTION)
      resourceGroup: '$(RESOURCEGROUP)'
      containerAppName: '${{ parameters.containerName }}'
      imageToDeploy: '$(ACRPRODLOGINSERVER)/${{ parameters.IMAGENAME }}:$(TAG)'
      ingress: external
      containerAppEnvironment: $(ENVIRONMENTNAME)
      targetPort: 80
      location: $(LOCATION)
      acrName: $(ACRPRODNAME)
      acrUsername: $(ACRPRODUSERNAME)
      acrPassword: $(ACRPRODPASSWORD) 